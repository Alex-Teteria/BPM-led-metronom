# BPM-метроном на мікроконтролері

## 1. Призначення

Система призначена для детекції beat та оцінки BPM аудіосигналу в реальному часі з подальшою індикацією темпу за допомогою LED-метронома. Алгоритм орієнтований на роботу з широким класом музичних сигналів без спектрального аналізу та без жорстких вимог до точності частоти дискретизації.

---

## 2. Загальна архітектура

### 2.1 Розподіл по ядрах

- **Core0**: детерміноване семплування ADC та формування фреймів
- **Core1**: DSP-пайплайн, beat detection, BPM-оцінка, керування LED

Архітектура мінімізує взаємний вплив обчислень DSP і семплування.

### 2.2 Обмін даними

- Подвійний буфер (double buffering)
- Синхронізація через lock
- Передача даних фреймами фіксованого розміру

---

## 3. Семплування

### 3.1 Метод семплування

- Семплування ADC з використанням DMA (або еквівалентного апаратного таймера),
  перевірено з використанням https://github.com/Alex-Teteria/MicroPython-RP2040-ADC-DMA-Extension, реалізує one-shot семплування    
- Частота дискретизації Fs задається апаратно

### 3.2 Вимоги до Fs

- **Абсолютна точність Fs**: не критична
- **Довготривала стабільність Fs**: помірно важлива
- **Миттєвий джиттер**: небажаний, але не критичний

Fs використовується лише для:

- визначення тривалості фрейма
- перерахунку BPM у фізичні одиниці  
Інші методи семплування (IRQ таймер, PIO) можливі, якщо вони гарантують фіксований інтервал семплування.

### 3.3 Доцільність використання PIO

---

## 4. Фреймова обробка

### 4.1 Розмір фрейма (FRAME_SIZE)

FRAME_SIZE визначає:

- часову роздільну здатність beat detection
- згладжування енергії
- затримку реакції системи

Малі фрейми:

- швидка реакція
- більша чутливість до шуму

Великі фрейми:

- стабільна енергія
- більша латентність

FRAME_SIZE обирається з умови:

- тривалість фрейма значно менша за період beat
- але значно більша за період аудіоосциляцій

---

## 5. DSP-пайплайн

### 5.1 Центрування сигналу

- Віднімання половини діапазону ADC
- Усунення DC-offset на вході

### 5.2 Енергетична ознака

Енергія фрейма:

E = sum(x[n]^2)

Система працює лише з інтегральною енергією, а не з формою сигналу.

### 5.3 LP-фільтр енергії

- Однополюсний IIR (leaky integrator)
- Еквівалент RC-інтегруючої ланки
- Формує повільну оцінку середньої енергії

LP не використовується для детекції beat, а лише як базова лінія.

### 5.4 Нормалізація (АРУ)

E_norm = E / (energy_lp + EPS)

Нормалізація:

- усуває залежність від абсолютного рівня сигналу
- робить систему інваріантною до підсилення та аліасингу

### 5.5 Обмеження (clamp)

- Верхня межа E_norm (типово 4–6)
- Захист адаптивних контурів від аномальних піків
- Значення підбирається емпірично на реальних даних

---

## 6. Adaptive K і beat detection

### 6.1 Adaptive K

- Повільна адаптація порогу
- Відслідковує типовий рівень E_norm
- Захищає від хибних спрацьовувань

### 6.2 Beat-критерій

Beat фіксується за умов:

- E_norm > K_eff
- додатній другий диференціал
- мінімальний міжбітий інтервал

Beat — це відносний транзієнт, а не абсолютна подія.

---

## 7. BPM-оцінка

### 7.1 Обчислення BPM

- BPM визначається з інтервалів між beat
- Використовується IIR-згладжування

### 7.2 Динамічний профіль

Параметри згладжування залежать від поточного BPM:

- повільні темпи → стабільність
- швидкі темпи → реактивність

Це зменшує помилки при зміні темпу.

---

## 8. LED-метроном

### 8.1 Принцип роботи

- LED працює від автономного фазового осцилятора
- Beat не керує LED напряму
- BPM лише параметризує період

### 8.2 Переваги підходу

- відсутність джитеру
- стабільна візуалізація темпу
- незалежність від помилок beat detector

---

## 9. Типи даних і числова модель

- Буфер семплів: цілі типи (int16)
- DSP і керування: float

Це оптимізує памʼять та швидкодію без втрати алгоритмічної коректності.

---

## 10. Портативність

### 10.1 Інваріантні частини

- Алгоритм DSP
- Beat detection
- BPM-логіка

### 10.2 Платформозалежні частини

- Семплування ADC
- Таймінг
- Паралелізм

Алгоритм може бути перенесений на ESP32 або інші MCU за умови забезпечення стабільного Fs та фреймової обробки.

---

## 11. Обмеження системи

- Не призначена для метрологічно точного BPM
- Не працює зі спектральними ознаками
- Орієнтована на ритмічні сигнали з явними транзієнтами

---

## 12. Адаптація та налаштування параметрів

Цей розділ описує процедуру первинної адаптації системи до конкретного класу сигналів та апаратної реалізації.

### 12.1 Класи параметрів

### 12.1.1 Таблиця основних параметрів

| Параметр             | Тип   | Типове значення | Діапазон  | Вплив на систему                         | Критичність |
| -------------------- | ----- | --------------- | --------- | ---------------------------------------- | ----------- |
| SAMPLE_FREQ          | int   | 6800 Гц         | 4–12 кГц  | Визначає часову шкалу, тривалість фрейма | Низька      |
| FRAME_SIZE           | int   | 148             | 64–256    | Латентність, стабільність energy         | Висока      |
| ENERGY_LP_ALPHA      | float | 0.15            | 0.05–0.25 | Часова стала baseline енергії            | Висока      |
| EPS                  | float | 1e-6            | 1e-9–1e-5 | Захист від ділення на нуль               | Низька      |
| E_norm clamp         | float | 5.0             | 4–6       | Захист adaptive-K від піків              | Середня     |
| K_BASE               | float | 1.3             | 1.1–1.6   | Мінімальна чутливість beat               | Висока      |
| K_ALPHA              | float | 0.05            | 0.02–0.1  | Швидкість адаптації порога               | Середня     |
| MIN_BEAT_INTERVAL_MS | int   | 250 мс          | 150–400   | Захист від подвійних beat                | Висока      |
| ALPHA_SLOW           | float | 0.10            | 0.05–0.15 | Стабільність BPM на повільних темпах     | Середня     |
| ALPHA_FAST           | float | 0.30            | 0.2–0.5   | Реакція BPM на швидких темпах            | Середня     |
| DT_MIN_SLOW          | int   | 500 мс          | 400–700   | Нижня межа BPM (slow)                    | Низька      |
| DT_MAX_SLOW          | int   | 2000 мс         | 1500–3000 | Верхня межа BPM (slow)                   | Низька      |
| DT_MIN_FAST          | int   | 200 мс          | 150–300   | Нижня межа BPM (fast)                    | Низька      |
| DT_MAX_FAST          | int   | 1200 мс         | 900–1600  | Верхня межа BPM (fast)                   | Низька      |

Параметри системи поділяються на такі групи:

1. **Параметри семплування**
   
   - SAMPLE_FREQ
   - FRAME_SIZE

2. **Параметри енергетичного контуру**
   
   - ENERGY_LP_ALPHA
   - EPS

3. **Параметри нормалізації та захисту**
   
   - Clamp для E_norm (наприклад 4–6)

4. **Параметри adaptive-K**
   
   - K_BASE
   - K_ALPHA
   - початкове значення K_lp

5. **Параметри BPM-фільтра**
   
   - ALPHA_SLOW / ALPHA_FAST
   - DT_MIN / DT_MAX

---

### 12.2 Рекомендована послідовність налаштування

1. **Фіксація Fs і FRAME_SIZE**
   
   - FRAME_SIZE підбирається з часової роздільності
   - Fs має бути стабільним, але не обовʼязково точним

2. **Налаштування ENERGY_LP_ALPHA**
   
   - LP повинен реагувати повільніше за beat
   - але швидше за зміну загальної гучності

3. **Вибір clamp для E_norm**
   
   - аналізується статистика E / ⟨E⟩
   - clamp ставиться між реальними beat і outliers

4. **Налаштування K_BASE і K_ALPHA**
   
   - K_BASE визначає мінімальну чутливість
   - K_ALPHA — швидкість адаптації до середовища

5. **Налаштування BPM-профілю**
   
   - перевіряється стабільність при зміні темпу
   - мінімізується jitter і пропуски

---

### 12.3 Критерії коректного налаштування

Система вважається коректно налаштованою, якщо:

- beat детектується стабільно без хибних спрацьовувань
- BPM сходиться за декілька beat
- після артефактів система швидко відновлює чутливість

---

### 12.4 Що не варто адаптувати

- Не варто підганяти параметри під один трек
- Не варто робити LP занадто швидким
- Не варто усувати всі хибні beat ціною втрати чутливості

---


